name: Build on new Home Assistant release

on:
  schedule:
    # Check every 6 hours for new HA releases
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  check-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Check latest HA release tag
        id: ha_release
        run: |
          LATEST=$(curl -s https://api.github.com/repos/home-assistant/core/releases/latest | jq -r .tag_name)
          echo "tag=$LATEST" >> "$GITHUB_OUTPUT"
          echo "Latest HA release: $LATEST"

      - name: Check if already built
        id: cache_check
        uses: actions/cache@v4
        with:
          path: .ha-release-marker
          key: ha-release-${{ steps.ha_release.outputs.tag }}

      - name: Create marker file
        if: steps.cache_check.outputs.cache-hit != 'true'
        run: echo "${{ steps.ha_release.outputs.tag }}" > .ha-release-marker

      - name: Checkout
        if: steps.cache_check.outputs.cache-hit != 'true'
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        if: steps.cache_check.outputs.cache-hit != 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push latest
        if: steps.cache_check.outputs.cache-hit != 'true'
        run: bash build.sh

      - name: Tag and push version
        if: steps.cache_check.outputs.cache-hit != 'true'
        env:
          TAG: ${{ steps.ha_release.outputs.tag }}
        run: |
          docker tag ghcr.io/roflmao/docker-ha-roflmao:latest "ghcr.io/roflmao/docker-ha-roflmao:$TAG"
          docker push "ghcr.io/roflmao/docker-ha-roflmao:$TAG"
